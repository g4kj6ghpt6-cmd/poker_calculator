<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德州扑克胜率计算器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #2d5016; color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { color: #2c3e50; margin: 0; }
        .reset-btn { padding: 10px 20px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .reset-btn:hover { background-color: #c0392b; }
        h2 { color: #34495e; margin-bottom: 15px; font-size: 1.5em; }
        h3 { color: #34495e; margin-bottom: 10px; font-size: 1.2em; }
        .setting-section { margin-bottom: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 6px; }
        .setting-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .setting-row label { font-weight: bold; min-width: 150px; }
        .setting-row select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .poker-table-container { display: flex; justify-content: center; margin: 30px 0; position: relative; }
        .poker-table { position: relative; width: 1200px; height: 700px; background: radial-gradient(ellipse at center, #006400 0%, #003300 100%); border-radius: 50%; border: 10px solid #8B4513; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3); display: flex; justify-content: center; align-items: center; }
        .community-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 8px; text-align: center; min-width: 400px; z-index: 10; }
        .public-cards-display { display: flex; flex-direction: column; gap: 10px; }
        .card-slots-row { display: flex; gap: 20px; justify-content: center; align-items: flex-start; flex-wrap: wrap; }
        .card-slot-group { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .section-label { font-weight: bold; color: #2c3e50; font-size: 12px; margin-bottom: 2px; }
        .card-slots { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .player-positions { position: absolute; width: 100%; height: 100%; border-radius: 50%; }
        .player-position { position: absolute; width: 150px; background-color: rgba(255, 255, 255, 0.95); border-radius: 8px; padding: 6px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); transform: translate(-50%, -50%); transition: all 0.3s ease; z-index: 15; display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100px; font-size: 10px; }
        .player-position.hidden { display: none; }
        .position-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; flex-wrap: wrap; gap: 6px; }
        .position-name { font-weight: bold; font-size: 0.8em; color: #2c3e50; white-space: nowrap; }
        .position-actions { display: flex; gap: 3px; flex-wrap: wrap; }
        .action-btn { padding: 2px 4px; border: none; border-radius: 3px; cursor: pointer; font-size: 9px; font-weight: bold; transition: background-color 0.2s; }
        .fold-btn { background-color: #e74c3c; color: white; }
        .fold-btn:hover { background-color: #c0392b; }
        .call-btn { background-color: #2ecc71; color: white; }
        .call-btn:hover { background-color: #27ae60; }
        .raise-btn { background-color: #f39c12; color: white; }
        .raise-btn:hover { background-color: #e67e22; }
        .player-info { display: flex; flex-direction: column; gap: 4px; font-size: 9px; width: 100%; max-width: 100%; }
        .hand-section, .chips-section { display: flex; align-items: flex-start; gap: 3px; flex-wrap: nowrap; width: 100%; flex-direction: row; }
        .hand-section label, .chips-section label { font-weight: bold; min-width: 35px; font-size: 9px; white-space: nowrap; flex-shrink: 0; }
        .hand-slots { display: flex; gap: 2px; flex-wrap: nowrap; flex: 1; flex-direction: row; width: auto; min-width: 0; }
        .hand-slot { width: 35px; height: 49px; border: 2px dashed #666; border-radius: 4px; background-color: rgba(255, 255, 255, 0.8); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #666; z-index: 15; flex-shrink: 0; }
        .hand-slot:hover { border-color: #3498db; background-color: rgba(52, 152, 219, 0.1); }
        .hand-slot.filled { border-style: solid; border-color: #28a745; background-color: white; }
        .chip-input { padding: 4px; border: 1px solid #ddd; border-radius: 3px; width: 80px; font-size: 12px; }
        .status-section { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; width: 100%; }
        .status-section label { font-weight: bold; min-width: 50px; font-size: 10px; }
        .status-toggle { display: flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 15px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 10px; }
        .status-toggle.active { background-color: #d4edda; color: #155724; }
        .status-toggle.folded { background-color: #f8d7da; color: #721c24; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; transition: all 0.2s ease; }
        .status-toggle.active .status-indicator { background-color: #28a745; }
        .status-toggle.folded .status-indicator { background-color: #dc3545; }
        .player-position.folded { opacity: 0.6; filter: grayscale(50%); }
        .player-position.folded .hand-slot { cursor: not-allowed; pointer-events: none; opacity: 0.5; }
        .status { font-weight: bold; padding: 2px 6px; border-radius: 3px; font-size: 11px; align-self: flex-start; }
        .active { background-color: #d4edda; color: #155724; }
        .folded { background-color: #f8d7da; color: #721c24; text-decoration: line-through; }
        .action-section { text-align: center; margin-bottom: 30px; }
        #calculate-btn { padding: 12px 24px; background-color: #3498db; color: white; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        #calculate-btn:hover { background-color: #2980b9; }
        .results { margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 6px; }
        .win-rate-display { margin: 8px 0; width: 100%; }
        .win-rate-info { display: flex; align-items: center; gap: 8px; width: 100%; }
        .win-rate-label { font-weight: bold; font-size: 12px; color: #2c3e50; min-width: 40px; }
        .win-rate-bar { flex: 1; height: 15px; background-color: #e0e0e0; border-radius: 8px; overflow: hidden; }
        .win-rate-fill { height: 100%; background-color: #3498db; transition: width 0.5s ease; }
        .win-rate-value { font-weight: bold; font-size: 12px; min-width: 50px; text-align: right; color: #2c3e50; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
        .modal.show { display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: white; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: #f8f9fa; border-bottom: 1px solid #ddd; }
        .modal-header h3 { margin: 0; color: #2c3e50; }
        .close { font-size: 24px; cursor: pointer; color: #666; transition: color 0.2s; }
        .close:hover { color: #333; }
        .modal-body { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .selected-cards { padding: 0 20px 20px 20px; background-color: white; border-bottom: 1px solid #eee; flex-shrink: 0; z-index: 10; }
        .cards-grid-container { padding: 20px; overflow-y: auto; max-height: 60vh; flex: 1; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 15px 20px; background-color: #f8f9fa; border-top: 1px solid #ddd; flex-shrink: 0; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; transition: background-color 0.2s; }
        .cancel-btn { background-color: #6c757d; color: white; }
        .cancel-btn:hover { background-color: #5a6268; }
        .confirm-btn { background-color: #28a745; color: white; }
        .confirm-btn:hover { background-color: #218838; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 20px; }
        .card { width: 80px; height: 112px; border-radius: 8px; background-color: white; border: 2px solid #ddd; display: flex; flex-direction: column; justify-content: space-between; padding: 8px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); position: relative; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border-color: #3498db; }
        .card.selected { border-color: #28a745; background-color: #d4edda; box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3); }
        .card.disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); border-color: #ccc; background-color: #f5f5f5; }
        .card.disabled:hover { transform: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); border-color: #ccc; background-color: #f5f5f5; }
        .card-value { font-size: 14px; font-weight: bold; }
        .card-suit { font-size: 18px; text-align: center; }
        .card-slots { display: flex; gap: 10px; flex-wrap: wrap; }
        .card-slot { width: 45px; height: 63px; border: 2px dashed #666; border-radius: 5px; background-color: rgba(255, 255, 255, 0.8); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; z-index: 15; }
        .card-slot:hover { border-color: #3498db; background-color: rgba(52, 152, 219, 0.1); }
        .card-slot.filled { border-style: solid; border-color: #28a745; background-color: white; }
        .card-slot, .hand-slot, .selected-card-item { width: 45px; height: 63px; }
        .selected-cards-list { display: flex; gap: 10px; flex-direction: row; flex-wrap: wrap; justify-content: flex-start; align-items: center; margin-bottom: 20px; }
        .hand-slot .card-slot-inner { width: 100%; height: 100%; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; padding: 6px; }
        .card.hearts .card-value, .card.hearts .card-suit, .card-slot-inner.hearts .card-value, .card-slot-inner.hearts .card-suit, .selected-card-item.hearts .card-value, .selected-card-item.hearts .card-suit { color: #e74c3c; }
        .card-slot-inner.hearts { background-color: rgba(231, 76, 60, 0.1); border: 1px solid #e74c3c; }
        .card.diamonds .card-value, .card.diamonds .card-suit, .card-slot-inner.diamonds .card-value, .card-slot-inner.diamonds .card-suit, .selected-card-item.diamonds .card-value, .selected-card-item.diamonds .card-suit { color: #e74c3c; }
        .card-slot-inner.diamonds { background-color: rgba(231, 76, 60, 0.1); border: 1px solid #e74c3c; }
        .card.clubs .card-value, .card.clubs .card-suit, .card-slot-inner.clubs .card-value, .card-slot-inner.clubs .card-suit, .selected-card-item.clubs .card-value, .selected-card-item.clubs .card-suit { color: #27ae60; }
        .card-slot-inner.clubs { background-color: rgba(39, 174, 96, 0.1); border: 1px solid #27ae60; }
        .card.spades .card-value, .card.spades .card-suit, .card-slot-inner.spades .card-value, .card-slot-inner.spades .card-suit, .selected-card-item.spades .card-value, .selected-card-item.spades .card-suit { color: #2c3e50; }
        .card-slot-inner.spades { background-color: rgba(44, 62, 80, 0.1); border: 1px solid #2c3e50; }
        .card.hearts { border-color: #e74c3c; background-color: rgba(231, 76, 60, 0.05); }
        .card.diamonds { border-color: #e74c3c; background-color: rgba(231, 76, 60, 0.05); }
        .card.clubs { border-color: #27ae60; background-color: rgba(39, 174, 96, 0.05); }
        .card.spades { border-color: #2c3e50; background-color: rgba(44, 62, 80, 0.05); }
        .selected-card-item.hearts { border-color: #e74c3c; background-color: rgba(231, 76, 60, 0.1); }
        .selected-card-item.diamonds { border-color: #e74c3c; background-color: rgba(231, 76, 60, 0.1); }
        .selected-card-item.clubs { border-color: #27ae60; background-color: rgba(39, 174, 96, 0.1); }
        .selected-card-item.spades { border-color: #2c3e50; background-color: rgba(44, 62, 80, 0.1); }
        @media (max-width: 1400px) { .poker-table { width: 800px; height: 500px; } .player-position { width: 150px; padding: 10px; } .player-position:nth-child(1) { top: 75%; left: 85%; } .player-position:nth-child(2) { top: 90%; left: 50%; } .player-position:nth-child(3) { top: 75%; left: 15%; } .player-position:nth-child(4) { top: 55%; left: 10%; } .player-position:nth-child(5) { top: 35%; left: 15%; } .player-position:nth-child(6) { top: 10%; left: 50%; } .player-position:nth-child(7) { top: 35%; left: 85%; } .player-position:nth-child(8) { top: 55%; left: 90%; } .position-name { font-size: 0.9em; } .action-btn { padding: 3px 6px; font-size: 11px; } }
        @media (max-width: 1024px) { .poker-table { width: 600px; height: 500px; } .player-position { width: 130px; padding: 8px; } .player-position:nth-child(1) { top: 75%; left: 82%; } .player-position:nth-child(2) { top: 90%; left: 50%; } .player-position:nth-child(3) { top: 75%; left: 18%; } .player-position:nth-child(4) { top: 55%; left: 12%; } .player-position:nth-child(5) { top: 35%; left: 18%; } .player-position:nth-child(6) { top: 12%; left: 50%; } .player-position:nth-child(7) { top: 35%; left: 82%; } .player-position:nth-child(8) { top: 55%; left: 88%; } }
        @media (max-width: 768px) { .container { padding: 10px; } .setting-row { flex-direction: column; align-items: flex-start; } .poker-table { width: 400px; height: 300px; } .player-position { width: 100px; padding: 6px; } .player-position:nth-child(1) { top: 75%; left: 80%; } .player-position:nth-child(2) { top: 95%; left: 50%; } .player-position:nth-child(3) { top: 75%; left: 20%; } .player-position:nth-child(4) { top: 50%; left: 10%; } .player-position:nth-child(5) { top: 25%; left: 20%; } .player-position:nth-child(6) { top: 5%; left: 50%; } .player-position:nth-child(7) { top: 25%; left: 80%; } .player-position:nth-child(8) { top: 50%; left: 90%; } .position-header { flex-direction: column; align-items: flex-start; gap: 5px; } .position-actions { width: 100%; justify-content: space-between; } .player-info { font-size: 9px; } .card { width: 60px; height: 84px; } .cards-grid { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); } .card-slot, .hand-slot, .selected-card-item { width: 45px; height: 63px; } .card-value { font-size: 14px; } .card-suit { font-size: 18px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>德州扑克胜率计算器</h1>
            <button id="reset-btn" class="reset-btn">初始化</button>
        </div>
        <div class="setting-section">
            <h2>桌位设置</h2>
            <div class="setting-row">
                <label for="player-count">玩家人数 (2-8):</label>
                <select id="player-count">
                    <option value="2">2人</option>
                    <option value="3">3人</option>
                    <option value="4">4人</option>
                    <option value="5">5人</option>
                    <option value="6">6人</option>
                    <option value="7">7人</option>
                    <option value="8">8人</option>
                </select>
            </div>
        </div>
        <div class="poker-table-container">
            <div class="poker-table">
                <div class="community-area">
                    <h3>公共牌</h3>
                    <div class="public-cards-display">
                        <div class="card-slots-row">
                            <div class="card-slot-group">
                                <div class="section-label">翻牌</div>
                                <div class="card-slots">
                                    <div class="card-slot" data-card-id="flop1" onclick="openCardSelector('flop', 3, updateFlopCards)"></div>
                                    <div class="card-slot" data-card-id="flop2" onclick="openCardSelector('flop', 3, updateFlopCards)"></div>
                                    <div class="card-slot" data-card-id="flop3" onclick="openCardSelector('flop', 3, updateFlopCards)"></div>
                                </div>
                            </div>
                            <div class="card-slot-group">
                                <div class="section-label">转牌</div>
                                <div class="card-slots">
                                    <div class="card-slot" data-card-id="turn" onclick="openCardSelector('turn', 1, updateCommunityCard)"></div>
                                </div>
                            </div>
                            <div class="card-slot-group">
                                <div class="section-label">河牌</div>
                                <div class="card-slots">
                                    <div class="card-slot" data-card-id="river" onclick="openCardSelector('river', 1, updateCommunityCard)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="player-positions" class="player-positions"></div>
            </div>
        </div>
        <div class="action-section">
            <button id="calculate-btn">计算胜率</button>
        </div>
        <div id="results" class="results"></div>
    </div>
    <div id="card-selector-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择扑克牌</h3>
                <span class="close" onclick="closeCardSelector()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="selected-cards">
                    <h4>已选择的牌:</h4>
                    <div id="selected-cards-list" class="selected-cards-list"></div>
                </div>
                <div class="cards-grid-container">
                    <div class="cards-grid" id="cards-grid"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeCardSelector()" class="btn cancel-btn">取消</button>
                <button onclick="confirmCardSelection()" class="btn confirm-btn">确认</button>
            </div>
        </div>
    </div>
    <script>
        const POSITION_NAMES = {0: '庄位 (BTN)', 1: '小盲 (SB)', 2: '大盲 (BB)', 3: '枪口 (UTG)', 4: '枪口+1 (UTG+1)', 5: '中位 (MP)', 6: '中位+1 (MP+1)', 7: '关煞位 (CO)'};
        const SUIT_SYMBOLS = {'h': '♥', 'd': '♦', 'c': '♣', 's': '♠'};
        const SUIT_NAMES = {'h': 'hearts', 'd': 'diamonds', 'c': 'clubs', 's': 'spades'};
        let gameState = {playerCount: 2, players: [], communityCards: {flop1: '', flop2: '', flop3: '', turn: '', river: ''}, currentStreet: 'preflop', usedCards: new Set()};
        let cardSelectorState = {targetId: null, maxSelect: 1, selectedCards: [], callback: null, args: []};
        
        function resetGame() {
            gameState = {playerCount: 2, players: [], communityCards: {flop1: '', flop2: '', flop3: '', turn: '', river: ''}, currentStreet: 'preflop', usedCards: new Set()};
            document.getElementById('player-count').value = gameState.playerCount;
            document.querySelectorAll('.card-slot').forEach(slot => { slot.className = 'card-slot'; slot.innerHTML = ''; });
            document.getElementById('results').innerHTML = '';
            generatePlayerPositions();
            initCardSelector();
        }
        
        function init() {
            const playerCountSelect = document.getElementById('player-count');
            playerCountSelect.value = gameState.playerCount;
            playerCountSelect.addEventListener('change', (e) => { gameState.playerCount = parseInt(e.target.value); generatePlayerPositions(); });
            document.getElementById('calculate-btn').addEventListener('click', calculateWinRates);
            document.getElementById('reset-btn').addEventListener('click', resetGame);
            generatePlayerPositions();
            initCardSelector();
        }
        
        function initCardSelector() {
            renderCardsGrid(createDeck());
        }
        
        function createDeck() {
            const values = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
            const suits = ['h', 'd', 'c', 's'];
            const deck = [];
            for (const value of values) for (const suit of suits) deck.push({value: value, suit: suit, symbol: SUIT_SYMBOLS[suit], name: `${value}${suit}`, suitName: SUIT_NAMES[suit]});
            return deck;
        }
        
        function renderCardsGrid(deck) {
            const grid = document.getElementById('cards-grid');
            grid.innerHTML = '';
            deck.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = `card ${card.suitName}`;
                cardElement.dataset.card = card.name;
                cardElement.innerHTML = `<div class="card-value">${card.value}</div><div class="card-suit">${card.symbol}</div><div class="card-value" style="transform: rotate(180deg)">${card.value}</div>`;
                if (gameState.usedCards.has(card.name)) cardElement.classList.add('disabled');
                cardElement.addEventListener('click', () => { if (!cardElement.classList.contains('disabled')) toggleCardSelection(card); });
                grid.appendChild(cardElement);
            });
        }
        
        function generatePlayerPositions() {
            const container = document.getElementById('player-positions');
            container.innerHTML = '';
            gameState.players = [];
            const POSITION_ORDER = [0, 1, 2, 3, 4, 5, 6, 7];
            for (let i = 0; i < gameState.playerCount; i++) {
                const positionIndex = POSITION_ORDER[i];
                const player = {id: i, positionIndex: positionIndex, positionName: POSITION_NAMES[positionIndex], hand: ['', ''], chips: 1000, status: 'active', action: null};
                gameState.players.push(player);
                const positionElement = document.createElement('div');
                positionElement.className = `player-position player-count-${gameState.playerCount}`;
                positionElement.dataset.playerId = player.id;
                positionElement.dataset.positionIndex = positionIndex;
                positionElement.innerHTML = `<div class="position-header"><div class="position-name">${player.positionName}</div></div><div class="player-info"><div class="hand-section"><label>起手牌:</label><div class="hand-slots"><div class="hand-slot" data-hand-index="0" onclick="openCardSelector('player-${player.id}-hand', 2, updatePlayerHands, ${player.id})"></div><div class="hand-slot" data-hand-index="1" onclick="openCardSelector('player-${player.id}-hand', 2, updatePlayerHands, ${player.id})"></div></div></div><div class="win-rate-display" id="win-rate-${player.id}"></div><div class="status-section"><label>状态:</label><div class="status-toggle ${player.status}" onclick="togglePlayerStatus(${player.id})"><div class="status-indicator"></div><span class="status-text">${player.status === 'active' ? '活跃' : '已弃牌'}</span></div></div></div>`;
                container.appendChild(positionElement);
            }
            setPlayerPositionsByCount(gameState.playerCount);
        }
        
        function setPlayerPositionsByCount(count) {
            document.querySelectorAll('.player-position').forEach(pos => { pos.style.position = 'absolute'; pos.style.transform = 'translate(-50%, -50%)'; });
            const btnPosition = document.querySelector('[data-position-index="0"]');
            if (btnPosition) btnPosition.style.top = '85%'; btnPosition.style.left = '50%';
            switch(count) {
                case 2: {
                    const sbPosition2 = document.querySelector('[data-position-index="1"]');
                    if (sbPosition2) { sbPosition2.style.top = '15%'; sbPosition2.style.left = '50%'; }
                    break;
                }
                case 3: {
                    const sbPosition3 = document.querySelector('[data-position-index="1"]');
                    const bbPosition3 = document.querySelector('[data-position-index="2"]');
                    if (sbPosition3) { sbPosition3.style.top = '15%'; sbPosition3.style.left = '35%'; }
                    if (bbPosition3) { bbPosition3.style.top = '15%'; bbPosition3.style.left = '65%'; }
                    break;
                }
                case 4: {
                    const sbPosition4 = document.querySelector('[data-position-index="1"]');
                    const bbPosition4 = document.querySelector('[data-position-index="2"]');
                    const utgPosition4 = document.querySelector('[data-position-index="3"]');
                    if (sbPosition4) { sbPosition4.style.top = '50%'; sbPosition4.style.left = '15%'; }
                    if (bbPosition4) { bbPosition4.style.top = '15%'; bbPosition4.style.left = '50%'; }
                    if (utgPosition4) { utgPosition4.style.top = '50%'; utgPosition4.style.left = '85%'; }
                    break;
                }
                case 5: {
                    const sbPosition5 = document.querySelector('[data-position-index="1"]');
                    const bbPosition5 = document.querySelector('[data-position-index="2"]');
                    const utgPosition5 = document.querySelector('[data-position-index="3"]');
                    const utg1Position5 = document.querySelector('[data-position-index="4"]');
                    if (sbPosition5) { sbPosition5.style.top = '50%'; sbPosition5.style.left = '15%'; }
                    if (bbPosition5) { bbPosition5.style.top = '15%'; bbPosition5.style.left = '35%'; }
                    if (utgPosition5) { utgPosition5.style.top = '15%'; utgPosition5.style.left = '65%'; }
                    if (utg1Position5) { utg1Position5.style.top = '50%'; utg1Position5.style.left = '85%'; }
                    break;
                }
                case 6: {
                    const sbPosition6 = document.querySelector('[data-position-index="1"]');
                    const bbPosition6 = document.querySelector('[data-position-index="2"]');
                    const utgPosition6 = document.querySelector('[data-position-index="3"]');
                    const utg1Position6 = document.querySelector('[data-position-index="4"]');
                    const mpPosition6 = document.querySelector('[data-position-index="5"]');
                    if (sbPosition6) { sbPosition6.style.top = '75%'; sbPosition6.style.left = '25%'; }
                    if (bbPosition6) { bbPosition6.style.top = '25%'; bbPosition6.style.left = '25%'; }
                    if (utgPosition6) { utgPosition6.style.top = '15%'; utgPosition6.style.left = '50%'; }
                    if (utg1Position6) { utg1Position6.style.top = '25%'; utg1Position6.style.left = '75%'; }
                    if (mpPosition6) { mpPosition6.style.top = '75%'; mpPosition6.style.left = '75%'; }
                    break;
                }
                case 7: {
                    const sbPosition7 = document.querySelector('[data-position-index="1"]');
                    const bbPosition7 = document.querySelector('[data-position-index="2"]');
                    const utgPosition7 = document.querySelector('[data-position-index="3"]');
                    const utg1Position7 = document.querySelector('[data-position-index="4"]');
                    const mpPosition7 = document.querySelector('[data-position-index="5"]');
                    const mp1Position7 = document.querySelector('[data-position-index="6"]');
                    if (sbPosition7) { sbPosition7.style.top = '75%'; sbPosition7.style.left = '25%'; }
                    if (bbPosition7) { bbPosition7.style.top = '50%'; bbPosition7.style.left = '15%'; }
                    if (utgPosition7) { utgPosition7.style.top = '25%'; utgPosition7.style.left = '25%'; }
                    if (utg1Position7) { utg1Position7.style.top = '25%'; utg1Position7.style.left = '75%'; }
                    if (mpPosition7) { mpPosition7.style.top = '50%'; mpPosition7.style.left = '85%'; }
                    if (mp1Position7) { mp1Position7.style.top = '75%'; mp1Position7.style.left = '75%'; }
                    break;
                }
                case 8: {
                    const sbPosition8 = document.querySelector('[data-position-index="1"]');
                    const bbPosition8 = document.querySelector('[data-position-index="2"]');
                    const utgPosition8 = document.querySelector('[data-position-index="3"]');
                    const utg1Position8 = document.querySelector('[data-position-index="4"]');
                    const mpPosition8 = document.querySelector('[data-position-index="5"]');
                    const mp1Position8 = document.querySelector('[data-position-index="6"]');
                    const coPosition8 = document.querySelector('[data-position-index="7"]');
                    if (sbPosition8) { sbPosition8.style.top = '75%'; sbPosition8.style.left = '25%'; }
                    if (bbPosition8) { bbPosition8.style.top = '50%'; bbPosition8.style.left = '15%'; }
                    if (utgPosition8) { utgPosition8.style.top = '25%'; utgPosition8.style.left = '25%'; }
                    if (utg1Position8) { utg1Position8.style.top = '15%'; utg1Position8.style.left = '50%'; }
                    if (mpPosition8) { mpPosition8.style.top = '25%'; mpPosition8.style.left = '75%'; }
                    if (mp1Position8) { mp1Position8.style.top = '50%'; mp1Position8.style.left = '85%'; }
                    if (coPosition8) { coPosition8.style.top = '75%'; coPosition8.style.left = '75%'; }
                    break;
                }
            }
        }
        
        function openCardSelector(targetId, maxSelect, callback, ...args) {
            let selectedCards = [];
            if (targetId.startsWith('player-')) {
                const parts = targetId.split('-');
                const playerId = parseInt(parts[1]);
                const player = gameState.players.find(p => p.id === playerId);
                if (player && player.hand) {
                    if (parts[3] === 'hand') {
                        if (player.hand[0]) selectedCards.push({value: player.hand[0][0], suit: player.hand[0][1], symbol: SUIT_SYMBOLS[player.hand[0][1]], name: player.hand[0], suitName: SUIT_NAMES[player.hand[0][1]]});
                        if (player.hand[1]) selectedCards.push({value: player.hand[1][0], suit: player.hand[1][1], symbol: SUIT_SYMBOLS[player.hand[1][1]], name: player.hand[1], suitName: SUIT_NAMES[player.hand[1][1]]});
                    }
                }
            } else if (targetId.startsWith('flop')) {
                if (targetId === 'flop') {
                    const flop1 = gameState.communityCards.flop1;
                    const flop2 = gameState.communityCards.flop2;
                    const flop3 = gameState.communityCards.flop3;
                    if (flop1) selectedCards.push({value: flop1[0], suit: flop1[1], symbol: SUIT_SYMBOLS[flop1[1]], name: flop1, suitName: SUIT_NAMES[flop1[1]]});
                    if (flop2) selectedCards.push({value: flop2[0], suit: flop2[1], symbol: SUIT_SYMBOLS[flop2[1]], name: flop2, suitName: SUIT_NAMES[flop2[1]]});
                    if (flop3) selectedCards.push({value: flop3[0], suit: flop3[1], symbol: SUIT_SYMBOLS[flop3[1]], name: flop3, suitName: SUIT_NAMES[flop3[1]]});
                }
            } else if (targetId === 'turn' || targetId === 'river') {
                const cardName = gameState.communityCards[targetId];
                if (cardName) selectedCards.push({value: cardName[0], suit: cardName[1], symbol: SUIT_SYMBOLS[cardName[1]], name: cardName, suitName: SUIT_NAMES[cardName[1]]});
            }
            cardSelectorState = {targetId: targetId, maxSelect: maxSelect, selectedCards: selectedCards, callback: callback, args: args};
            renderCardsGrid(createDeck());
            document.getElementById('card-selector-modal').classList.add('show');
            updateSelectedCardsList();
            updateCardSelectionUI();
        }
        
        function closeCardSelector() {
            document.getElementById('card-selector-modal').classList.remove('show');
            cardSelectorState = {targetId: null, maxSelect: 1, selectedCards: [], callback: null};
            updateSelectedCardsList();
        }
        
        function toggleCardSelection(card) {
            const index = cardSelectorState.selectedCards.findIndex(c => c.name === card.name);
            if (index > -1) {
                cardSelectorState.selectedCards.splice(index, 1);
            } else {
                if (cardSelectorState.selectedCards.length < cardSelectorState.maxSelect) {
                    cardSelectorState.selectedCards.push(card);
                }
            }
            updateCardSelectionUI();
            updateSelectedCardsList();
        }
        
        function updateCardSelectionUI() {
            const cards = document.querySelectorAll('.card');
            const maxReached = cardSelectorState.selectedCards.length >= cardSelectorState.maxSelect;
            cards.forEach(cardElement => {
                const cardName = cardElement.dataset.card;
                const isSelected = cardSelectorState.selectedCards.some(c => c.name === cardName);
                if (isSelected) {
                    cardElement.classList.add('selected');
                } else {
                    cardElement.classList.remove('selected');
                    if (maxReached) {
                        cardElement.classList.add('disabled');
                    } else {
                        if (!gameState.usedCards.has(cardName)) {
                            cardElement.classList.remove('disabled');
                        }
                    }
                }
            });
        }
        
        function updateSelectedCardsList() {
            const list = document.getElementById('selected-cards-list');
            list.innerHTML = '';
            cardSelectorState.selectedCards.forEach((card, index) => {
                const cardItem = document.createElement('div');
                cardItem.className = 'selected-card-item ' + card.suitName;
                cardItem.innerHTML = `<div class="card-value">${card.value}</div><div class="card-suit">${card.symbol}</div><div class="card-value" style="transform: rotate(180deg)">${card.value}</div><div class="remove-card" onclick="removeSelectedCard(${index})" style="position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;">×</div>`;
                list.appendChild(cardItem);
            });
        }
        
        function removeSelectedCard(index) {
            cardSelectorState.selectedCards.splice(index, 1);
            updateCardSelectionUI();
            updateSelectedCardsList();
        }
        
        function confirmCardSelection() {
            if (cardSelectorState.selectedCards.length === 0) { alert('请至少选择一张卡牌'); return; }
            if (cardSelectorState.callback) {
                cardSelectorState.callback(cardSelectorState.targetId, cardSelectorState.selectedCards, ...cardSelectorState.args);
            }
            closeCardSelector();
        }
        
        function updateCommunityCard(targetId, cards) {
            const card = cards[0];
            const oldCard = gameState.communityCards[targetId];
            if (oldCard) gameState.usedCards.delete(oldCard);
            gameState.communityCards[targetId] = card.name;
            gameState.usedCards.add(card.name);
            updateCommunityCardDisplay(targetId, card);
        }
        
        function updateCommunityCardDisplay(cardId, card) {
            const slot = document.querySelector(`[data-card-id="${cardId}"]`);
            if (slot) {
                slot.className = 'card-slot filled';
                slot.innerHTML = `<div class="card-slot-inner ${card.suitName}"><div class="card-value">${card.value}</div><div class="card-suit">${card.symbol}</div><div class="card-value" style="transform: rotate(180deg)">${card.value}</div></div>`;
            }
        }
        
        function updateFlopCards(targetId, cards) {
            if (cards.length !== 3) { alert('请选择3张翻牌'); return; }
            updateCommunityCard('flop1', [cards[0]]);
            updateCommunityCard('flop2', [cards[1]]);
            updateCommunityCard('flop3', [cards[2]]);
        }
        
        function updatePlayerHands(targetId, cards, playerId) {
            if (cards.length !== 2) { alert('请选择2张手牌'); return; }
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            if (player.hand[0]) gameState.usedCards.delete(player.hand[0]);
            if (player.hand[1]) gameState.usedCards.delete(player.hand[1]);
            player.hand[0] = cards[0].name;
            player.hand[1] = cards[1].name;
            gameState.usedCards.add(cards[0].name);
            gameState.usedCards.add(cards[1].name);
            updatePlayerHandDisplay(playerId);
        }
        
        function updatePlayerHandDisplay(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            const handSlots = document.querySelector(`[data-player-id="${playerId}"]`).querySelectorAll('.hand-slot');
            handSlots.forEach((slot, index) => {
                const cardName = player.hand[index];
                if (cardName) {
                    const value = cardName[0];
                    const suit = cardName[1];
                    const symbol = SUIT_SYMBOLS[suit];
                    const suitName = SUIT_NAMES[suit];
                    slot.className = 'hand-slot filled';
                    slot.innerHTML = `<div class="card-slot-inner ${suitName}"><div class="card-value">${value}</div><div class="card-suit">${symbol}</div><div class="card-value" style="transform: rotate(180deg)">${value}</div></div>`;
                } else {
                    slot.className = 'hand-slot';
                    slot.innerHTML = '';
                }
            });
        }
        
        function togglePlayerStatus(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            player.status = player.status === 'active' ? 'folded' : 'active';
            const element = document.querySelector(`[data-player-id="${playerId}"]`);
            const statusToggle = element.querySelector('.status-toggle');
            const statusText = element.querySelector('.status-text');
            const handSlots = element.querySelectorAll('.hand-slot');
            statusToggle.className = `status-toggle ${player.status}`;
            statusText.textContent = player.status === 'active' ? '活跃' : '已弃牌';
            if (player.status === 'folded') {
                element.classList.add('folded');
                handSlots.forEach(slot => { slot.style.pointerEvents = 'none'; slot.style.opacity = '0.5'; });
            } else {
                element.classList.remove('folded');
                handSlots.forEach(slot => { slot.style.pointerEvents = 'auto'; slot.style.opacity = '1'; });
            }
        }
        
        function getActivePlayers() {
            return gameState.players.filter(p => p.status === 'active');
        }
        
        function generateAllPossibleCommunityCards(currentCommunityCards) {
            const baseCards = { ...currentCommunityCards };
            const missingCards = [];
            if (!baseCards.flop1) missingCards.push('flop1');
            if (!baseCards.flop2) missingCards.push('flop2');
            if (!baseCards.flop3) missingCards.push('flop3');
            if (!baseCards.turn) missingCards.push('turn');
            if (!baseCards.river) missingCards.push('river');
            if (missingCards.length === 0) {
                return [baseCards];
            }
            const deck = createDeck();
            const usedCards = new Set(gameState.usedCards);
            const availableCards = deck.filter(card => !usedCards.has(card.name));
            const allCombinations = [];
            function generateCombinations(current, index, usedIndices) {
                if (index === missingCards.length) {
                    allCombinations.push({ ...baseCards, ...current });
                    return;
                }
                for (let i = 0; i < availableCards.length; i++) {
                    if (!usedIndices.has(i)) {
                        const newCurrent = { ...current };
                        newCurrent[missingCards[index]] = availableCards[i].name;
                        const newUsedIndices = new Set(usedIndices);
                        newUsedIndices.add(i);
                        generateCombinations(newCurrent, index + 1, newUsedIndices);
                    }
                }
            }
            generateCombinations({}, 0, new Set());
            return allCombinations;
        }
        
        function calculateWinRates() {
            const activePlayers = getActivePlayers();
            if (activePlayers.length < 2) { alert('至少需要2个活跃玩家才能计算胜率'); return; }
            const invalidPlayers = activePlayers.filter(p => !p.hand[0] || !p.hand[1]);
            if (invalidPlayers.length > 0) { alert('请为所有活跃玩家填写完整的起手牌'); return; }
            const allPossibleCommunityCards = generateAllPossibleCommunityCards(gameState.communityCards);
            if (allPossibleCommunityCards.length === 0) { alert('无法生成可能的公共牌组合'); return; }
            const winCounts = activePlayers.map(() => 0);
            const totalCombinations = allPossibleCommunityCards.length;
            allPossibleCommunityCards.forEach(simulatedCards => {
                const simulatedCardsArray = [];
                Object.values(simulatedCards).forEach(card => { if (card) simulatedCardsArray.push(card); });
                const playerStrengths = activePlayers.map(player => {
                    return { playerId: player.id, strength: evaluateHand(player.hand, simulatedCardsArray) };
                });
                const maxStrength = Math.max(...playerStrengths.map(ps => ps.strength));
                const winners = playerStrengths.filter(ps => ps.strength === maxStrength);
                if (winners.length === 1) {
                    const winnerIndex = activePlayers.findIndex(p => p.id === winners[0].playerId);
                    winCounts[winnerIndex]++;
                } else {
                    const winShare = 1 / winners.length;
                    winners.forEach(winner => {
                        const winnerIndex = activePlayers.findIndex(p => p.id === winner.playerId);
                        winCounts[winnerIndex] += winShare;
                    });
                }
            });
            const winRates = activePlayers.map((player, index) => {
                return { playerId: player.id, positionName: player.positionName, winRate: (winCounts[index] / totalCombinations) * 100 };
            });
            displayResults(winRates);
        }
        
        function evaluateHand(hand, communityCards) {
            const allCards = [...hand, ...communityCards];
            const parsedCards = allCards.map(card => {
                return { value: getCardValue(card), suit: getCardSuit(card) };
            });
            parsedCards.sort((a, b) => b.value - a.value);
            let handStrength = 0;
            if (isRoyalFlush(parsedCards)) handStrength = 1000000;
            else if (isStraightFlush(parsedCards)) handStrength = 900000 + parsedCards[0].value;
            else if (isFourOfAKind(parsedCards)) {
                const valueCounts = getValueCounts(parsedCards);
                const fourValue = Object.keys(valueCounts).find(key => valueCounts[key] === 4);
                const kicker = Object.keys(valueCounts).find(key => valueCounts[key] === 1);
                handStrength = 800000 + parseInt(fourValue) * 100 + parseInt(kicker);
            } else if (isFullHouse(parsedCards)) {
                const valueCounts = getValueCounts(parsedCards);
                const threeValue = Object.keys(valueCounts).find(key => valueCounts[key] === 3);
                const pairValue = Object.keys(valueCounts).find(key => valueCounts[key] === 2);
                handStrength = 700000 + parseInt(threeValue) * 100 + parseInt(pairValue);
            } else if (isFlush(parsedCards)) {
                handStrength = 600000 + parsedCards[0].value * 10000 + parsedCards[1].value * 100 + parsedCards[2].value;
            } else if (isStraight(parsedCards)) {
                handStrength = 500000 + parsedCards[0].value;
            } else if (isThreeOfAKind(parsedCards)) {
                const valueCounts = getValueCounts(parsedCards);
                const threeValue = Object.keys(valueCounts).find(key => valueCounts[key] === 3);
                const kickers = Object.keys(valueCounts).filter(key => valueCounts[key] === 1).map(key => parseInt(key)).sort((a, b) => b - a);
                handStrength = 400000 + parseInt(threeValue) * 10000 + kickers[0] * 100 + kickers[1];
            } else if (isTwoPair(parsedCards)) {
                const valueCounts = getValueCounts(parsedCards);
                const pairs = Object.keys(valueCounts).filter(key => valueCounts[key] === 2).map(key => parseInt(key)).sort((a, b) => b - a);
                const kicker = Object.keys(valueCounts).find(key => valueCounts[key] === 1);
                handStrength = 300000 + pairs[0] * 10000 + pairs[1] * 100 + parseInt(kicker);
            } else if (isOnePair(parsedCards)) {
                const valueCounts = getValueCounts(parsedCards);
                const pairValue = Object.keys(valueCounts).find(key => valueCounts[key] === 2);
                const kickers = Object.keys(valueCounts).filter(key => valueCounts[key] === 1).map(key => parseInt(key)).sort((a, b) => b - a);
                handStrength = 200000 + parseInt(pairValue) * 10000 + kickers[0] * 1000 + kickers[1] * 100 + kickers[2];
            } else {
                handStrength = parsedCards[0].value * 10000 + parsedCards[1].value * 1000 + parsedCards[2].value * 100 + parsedCards[3].value * 10 + parsedCards[4].value;
            }
            return handStrength;
        }
        
        function isRoyalFlush(cards) { return isStraightFlush(cards) && cards[0].value === 14 && cards[1].value === 13 && cards[2].value === 12 && cards[3].value === 11 && cards[4].value === 10; }
        function isStraightFlush(cards) { return isFlush(cards) && isStraight(cards); }
        function isFourOfAKind(cards) { const valueCounts = getValueCounts(cards); return Object.values(valueCounts).includes(4); }
        function isFullHouse(cards) { const valueCounts = getValueCounts(cards); const counts = Object.values(valueCounts).sort((a, b) => b - a); return counts[0] === 3 && counts[1] === 2; }
        function isFlush(cards) { const suitCounts = getSuitCounts(cards); return Object.values(suitCounts).some(count => count >= 5); }
        function isStraight(cards) {
            const uniqueValues = [...new Set(cards.map(card => card.value))].sort((a, b) => b - a);
            for (let i = 0; i <= uniqueValues.length - 5; i++) {
                if (uniqueValues[i] - uniqueValues[i + 4] === 4) return true;
            }
            return uniqueValues.includes(14) && uniqueValues.includes(2) && uniqueValues.includes(3) && uniqueValues.includes(4) && uniqueValues.includes(5);
        }
        function isThreeOfAKind(cards) { const valueCounts = getValueCounts(cards); return Object.values(valueCounts).includes(3); }
        function isTwoPair(cards) { const valueCounts = getValueCounts(cards); const pairs = Object.values(valueCounts).filter(count => count >= 2); return pairs.length >= 2; }
        function isOnePair(cards) { const valueCounts = getValueCounts(cards); return Object.values(valueCounts).includes(2); }
        function getValueCounts(cards) { const counts = {}; cards.forEach(card => { counts[card.value] = (counts[card.value] || 0) + 1; }); return counts; }
        function getSuitCounts(cards) { const counts = {}; cards.forEach(card => { counts[card.suit] = (counts[card.suit] || 0) + 1; }); return counts; }
        function getCardValue(card) { if (!card) return 0; const value = card[0]; switch (value) { case 'A': return 14; case 'K': return 13; case 'Q': return 12; case 'J': return 11; case 'T': return 10; default: return parseInt(value); } }
        function getCardSuit(card) { if (!card) return ''; return card[1]; }
        
        function displayResults(winRates) {
            winRates.sort((a, b) => b.winRate - a.winRate);
            winRates.forEach(rate => {
                const winRateElement = document.getElementById(`win-rate-${rate.playerId}`);
                if (winRateElement) {
                    winRateElement.innerHTML = `<div class="win-rate-info"><div class="win-rate-label">胜率:</div><div class="win-rate-bar"><div class="win-rate-fill" style="width: ${Math.min(rate.winRate, 100)}%"></div></div><div class="win-rate-value">${rate.winRate.toFixed(1)}%</div></div>`;
                }
            });
            document.getElementById('results').innerHTML = '';
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>